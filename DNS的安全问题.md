# DNS的安全问题
#### 本文来自SANS Institute阅览室网站。

- **摘要**：DNS依然是黑客很好的攻击的目标，BIND作为服务器软件在世界各地普遍存在，以及黑客能够成功的接管服务器或者通过使用DNS来实现重新定向流量时可以预期的可能性，都是使DNS成为安全问题来源的一些因素。
- 本文先回顾了DNS工作的一些基础知识，然后解释黑客使用自身的优势去实现攻击DNS协议使用的不同方式。我们将关注我们所听到的所有术语之间的关系，这些术语通常会被误用。然后我们将回顾不同的可能的服务器攻击，最后解释一些可以用来防止这些问题的方法。

### 介绍
- 人类不能像电脑一样思考，他们不能记住几十个IP地址，他们需要简单易记的名字来定位邮件服务器或者他们最喜欢的网页。
- 为了使我们能够在互联网上更容易的生活，DNS因此被发明了。与此同时，各种各样的黑客也有了新的娱乐场所。
- 此外，DNS的目的使其成为一个非常敏感的领域，因为这个是客户端连接定位的地方，黑帽黑客能够成功破解DNS的可能性是巨大的（一个用户能够被定向到黑客所控制的主机，无论他使用的是什么服务：http,ftp,telnet等），任何事情都是有可能的。
- 有两种方法可攻击DNS：一是使用协议攻击（基于DNS实际工作方式的攻击），二是
使用服务器攻击（基于运行DNS服务的程序或者机器的漏洞的攻击）。我们将看到这两种攻击，以及我们该如何去防止它们和为什么我们要去担心DNS攻击。但是，我们要先尝试去理解DNS的基础知识。
### A.DNS如何工作
- DNS代表域名服务，总之，它就是把主机名翻译为IP地址。
- 互联网是一个IP网络，每台主机都受到IP地址的影响，其他任何愿意通信的主机都需要知道IP地址。但是人类不可能记住互联网上所有的IP地址，可以在本地为每台计算机创建IP地址和域名的一个映射。但是，考虑到网络上计算机数量和它们的名称或地址修改的速度，这些表的更新会非常的复杂和缓慢。
- DNS提供一种可以知道网络上任何主机的IP地址的方法，它和任何其他目录服务贸易区别。
- 如下图：实现主机A和主机B之间相互通信，就得知道彼此之前的IP地址，于是A先去访问域名系统，得到B的IP后，即可和B进行通信
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS1.png)
- DNS是一种分层服务。它的名称有一个结构：它可以是```server1.web.yahoo.com或pc12.lab25.univ-berlin.de```
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS2.png)
- 一个主机是此树上的叶子，任何其他节点称为“域”。在我们的示例中，server1是```web.yahoo.com```域中的主机之一
- 我们需要服务器负责查找任何name-ip的映射。当这些服务器可以使用域中所有主机的主机名映射ip地址时，这些服务器称为域的“权威”。
- 当主机请求映射时，搜索将从树的顶部开始向下。在我们的示例中，我们可能有一个```Univ-berlin.de```域的DNS服务器，它可能知道```pc12.lab25.univ-berlin.de```的IP地址，或者该主机的权威服务器可能更低，在```Lab22.Univ-berlin.de```的级别。```.de```级别的DNS服务器将搜索定向到域名```univ-berlin de```等。
- 参考1提供了DNS基础知识的更多详细信息。
#### 迭代和递归查询
- 在进行了解攻击之前，我们需要了解递归和迭代查询的区别。
- 当主机查询DNS服务器时，它可以选择使用递归查询。在这种情况下，客户端需要答案，或者在任何一个地方都找不到它正在寻找的内容的错误信息，我们看到查询的主机必须尽一切努力才能找到答案，查询其他服务器直到获取信息，或者到查询失败。
- 当主机以迭代方式查询DNS服务器时，如果DNS服务器的缓存中有答案，就马上把答案给客户端，如果缓存中没有，那么客户端将会收到一个“推荐”，这是一个可能知道答案的服务器的名称（我们谈到的层次结构中较低级别的权威服务器）。
- 递归查询通常由客户端主机进行，因此它们不必处理整个搜索过程，而本地DNS服务器通常会进行迭代请求。
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS3.png)
- 参考文献2提供了一个小程序，用于演示这种不同类型的请求的特殊性
### B. DNS:协议攻击
- 就像前面所说的，DNS协议攻击基于DNS协议实现中的缺陷——DNS在Internet上的实际工作方式。
- 在谈论DNS协议攻击时，我们经常听到3个术语
  -  DNS欺骗
  -  DNS ID黑客攻击
  -  DNS缓存中毒
- 我们将根据具体情况解释每种方法的含义以及它们之间的联系。
- DNS缓存中毒涉及一种攻击，包括使DNS服务器缓存错误信息：通常是将名称映射到“错误”IP地址的错误记录。我们将看到黑客可以有不同的方式可以做到这一点，并且它们通常与DNS欺骗有关。随着DNS缓存中毒，黑客将尝试为特定请求做出他想要的回答。例如，上式使```ns.defence.gov```DNS使用黑客计算机的IP回答有关```telnetaccess.defence.gov```的IP的任何查询。
- 缓存中毒可以通过相关数据或者不相关数据进行攻击（我们将在后面看到它们）以及使用DNS欺骗来完成。
- DNS欺骗指的是回答用于其他服务器（“真正的”DNS服务器）的DNS请求的操作。这可以在服务器-服务器之间交换（DNS服务器要求另一个进行映射）或者客户端-服务器对话框中（当客户端要求DNS服务器进行映射时），没有功能差异。黑客通过数据包的源地址字段中回答DNS服务器的IP地址来“欺骗”DNS服务器的答案。
- 但是这不足以欺骗DNS回复。DNS使用ID号来识别查询和回答，因此黑客需要找到用户正在等待的ID。因此黑客将使用DNS ID黑客攻击。使用DNS欺骗，黑客将尝试模拟DNS回复，以便请求客户端被误导，但不会触及模拟DNS的DNS缓存。
- 注意：如果请求客户端是另一个DNS服务器，那么它的缓存将会中毒，因此这将是一种缓存中毒的方法。
- 鉴于“客户误导”（让客户主机首先进入它不愿意去的地方）的事实一般是DNS黑客攻击的基本目的，那么我们最终会得到这样的结论：
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS4.png)
- 我们已经定义了概念（缓存中毒，DNS欺骗和客户端误导）。现在我们将解释真正的攻击（相关和非相关数据攻击以及DNS ID黑客攻击）是怎么工作的。参考文献4和5将提供有关ID黑客攻击和缓存中毒攻击的更多的信息。
#### 不相关数据攻击
- 这是第一次攻击，最简单和最广泛使用
  - 黑客向受害者DNS询问他控制DNS域中不存在的名称映射。黑客使用“递归”查询，以便远程DNS服务器自己进行进一步查询。
  - 远程DNS不知道这种映射，它将去询问负责所需域的DNS服务器。要记住的是此服务器受黑客控制
  - 黑客将回答并在答案中添加他想要缓存在受害者DNS缓存中的任何内容。这样他就可以中毒远程DNS服务器的缓存。
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS5.png)
- 通过禁止与要缓存的原始请求无关的内容，已在BIND中修复这个问题。
#### 相关数据攻击
- 攻击与无关的数据攻击完全相同，但这次黑客必须制作与原始查询相关的“额外”信息。他通过添加指向不相关数据的MX.CNAME或NS记录来解决此问题。我们可以在DNS数据库中找到的这三条记录不是IP地址和主机名之间的真实“映射”。它们指出了其他有用的信息（MX：域的邮件服务器，CNAME:Canonical名称，NS：域的DNS服务器）。
- 因此，这些记录中的信息与原始请求“相关”，但它们可以指向黑客想要缓存的完全不同的信息。
- 通过拒绝所有“区外”信息，也就是说所有与DNS负责的区域不完全和和直接相关的信息，BIND中也解决了这个问题。
- 这两种攻击都比较老，在BIND上不再使用。实际上，自从它们被发现后已经发布了许多补丁。但是，我们仍然通过DNS ID 黑客技术听到DNS欺骗。
### DNS ID攻击
- 正如前面解释的那样，DNS ID黑客攻击是黑客成功模仿DNS服务器的必要技术（这是DNS欺骗的基础）。实际上，能够伪造出一个回复，黑客就必须使用DNS服务器的IP地址作为他自己IP数据包中的源地址，然后使用正确的ID号，否则，客户端不会将回复考虑在内。
- 客户端将使用特定的ID号向DNS服务器发送查询。服务器将使用相同的ID号进行回复，这个ID号是黑客必须要找到的。
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS6.png)
- 在局域网上获取ID非常的简单，黑客所要做的就是嗅探网络进行初始查询，并且比DNS更快地回答（这在局域网上很容易），这样来自真实的DNS的回答就因为延迟而被丢弃。
- 当黑客和受害者主机不在一个局域网时，他有四种方法来猜测用户ID
  -  测试ID标志的所有可能的值（或者在NS回复之前尽可能多的随机值）。这是一个相当过时的且没有用的方法，因为它唯一的优点就是让你知道ID是什么。
  -  充斥DNS服务器以花更多时间尝试不同的ID号，黑客甚至希望他能使服务器崩溃。
  -  同时发送几百条回复，以增加找到好的ID的机会。黑客可以使用不同的范围一个接一个地执行此操作，直到服务器回复。
  -  使用服务器中的漏洞，知道其中的漏洞只会将ID号从一个请求增加到另一个请求。这适用于服务器-服务器的对话框（下图的“客户端”是DNS服务器，黑客正试图中毒它的缓存）。在这种情况下，黑客可以首先使用黑客控制的区域中的主机名向客户端发出请求，并嗅探受害DNS服务器使用的ID。
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS7.png)
- 这样黑客就知道受害者服务器当前使用的ID的范围。他现在所要做的只是向他想要毒害的受害者的缓存的主机名发送请求，并使用增加的被盗ID值伪造答案（使用几个回复将增加受害者受害的机率）。
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS8.png)
- 如果黑客无法控制DNS，他仍然可以尝试一系列随机ID，直到真正的服务器回复得很晚。如果黑客收到受害者的答案，说地址是"yyy"，那么，它就有效了。否则，这意味着为时已晚，并且可以使用其他查询尝试另一个范围。
- 注意：Windows95中存在一个漏洞，黑客很容易猜到ID：Windows默认使用1，然后如果其他查询直接跟随则递增。
- DNS服务器软件中的这种缺陷是协议攻击遇到服务器攻击的地方。
###  C. DNS:服务器攻击
- 详细说明这些攻击都很难，因为它们发展得很快。一旦发现错误就会释放补丁，反之亦然。
- 两种攻击可以针对服务器而不是协议本身
  - 攻击利用DNS软件实现中的错误（例如BIND中的缓存器溢出）或DNS服务器计算机上的任何其他正在运行的服务。 
  - 拒绝服务攻击（例如使用泛洪，使用带内攻击的DNS服务或者通常使用用ICMP smurfing的机器）
- 这里给的建议是尽可能多地更新并了解任何新发现的漏洞。许多网站（如```www.securityfocues.com```或```www.cert.com```）将编制所有的现有的错误，漏洞和修复程序，有些人甚至专注于BIND。
### D.相关性和如何保护
- 大多数问题已经通过补丁、BIND等新版本得到解决，但根据```menandmice.com```威胁依然存在
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/DNS9.png)
- 本网站还提供了很多令人震惊的调查
- 我们听到很多关于DNSSEC的信息，这是一个安全DNS交易的命题（```RFC 2535:http://www.ietf.org/rfc/rfc2535.txt```）。这似乎是一个非常好的解决方案，它解决了我们在本文中讨论的大多数协议问题。但是，由于后兼容性的原因，这将在相当长的一段时间内无法实现，当前的网络管理员应该考虑其他方法来保护网络免受这些威胁。
- 要保护DNS服务器或服务器组，还有很多工作要做。参考文献8对此主题非常明确，并提供了在BIND上实现这些建议的方法。
- 我们可以引用其中一些方法，特别是与我们在本文中看到的问题完全匹配的方法。
  - 禁止递归查询以防止欺骗
  - 尽可能的更新BIND以限制bug问题
  - 为避免出现单点故障，不要将所有DNS服务器放在同一子网上，甚至不要放在同一个路由器或同一租用线路后面
  - 将可能的查询和允许查询的可能主机限制为最小值
- 我们没有谈论区域转移，因为这是一种用于收集信息而非真正“破解”的方法。发布特定请求（AXFR），黑客可以检索DNS服务器数据库的全部内容。这通常用于将DNS辅助服务器与主服务器同步。这样黑客可以收集有关受害者网络的大量信息（主机数量，名称，地址）以及识别潜在的特定目标（服务器，如邮件、DNS等）。当然，关闭此功能是一个好主意，或者至少将其限制在需要它的特定主机上。
- DNS架构的一个好方法是“拆分服务”或“拆分DNS架构”。原则如下：我们将DNS系统分为两部分，一部分负责宣传我们权威的名称到地址映射，另一部分是解决来自内部的请求，或者更一般地说是“可信”的主机。这样，如果外部DNS被黑客攻击，至少它不会影响提供给内部主机的服务。
### E：总结
- DNS不是新的，DNS黑客也已经存在了一段时间。破解DNS的技术越来越好，DNS无法使用演进技术进行反击，因为它仍然必须保持向后兼容性。
- 这就是为什么在IPv6及其承诺的所有相关安全功能出现之前，我们必须继续修补我们的BIND版本。
### F：参考文献
- Stevens, Glenn. “域名服务”. June 21, 1995. URL: http://eeunix.ee.usm.maine.edu/guides/dns/dns.html
- Kulapala, Beshan. “DNS中的递归/迭代查询”. URL: http://wps.aw.com/wps/media/objects/221/227091/applets/dns/dns.html 
- “www.menandmice.com”. “DNS调查”. 2002. URL:  http://www.menandmice.com/6000/6000_domain_health.html 
- “Gamma”. “DNS ID预测和利用”. August 1998. URL: http://c0vertl.tripod.com/text/dnsattack.txt 
- Erdfelt, Johannes. “您想知道的有关DNS欺骗的一切”. July 25, 1997. URL: http://www.the-project.org/admins/0897-1097/0381.html 
- UK Security Online Ltd. “黑客威胁 -  DNS服务器攻击”. 2002. URL:  http://www.uksecurityonline.com/threat/dns.php 
-  Carnegie Mellon University. “CERT Advisory CA-2001-02 BIND中的多个漏洞”. Aug 2001. URL: http://www.cert.org/advisories/CA-2001-02.html 
- Liu, Cricket. “保护Internet名称服务器”. Feb 2001. URL: http://www.linuxsecurity.com/resource_files/server_security/securing_an_internet _name_server.pdf 